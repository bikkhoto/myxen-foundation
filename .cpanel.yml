---
# MyXen Foundation cPanel Deployment Configuration
# Automatically deploys to cPanel hosting on push to main branch

deployment:
  tasks:
    # Set deployment path to studyproglobal.com.bd directory
    - export DEPLOYPATH=/home/studyproglobal.com.bd
    - export BACKENDPATH=/home/studyproglobal.com.bd/studypro-backend
    - export NODE_ENV=production
    
    # Clean up previous deployment (optional - uncomment if needed)
    # - /bin/rm -rf $DEPLOYPATH/*
    
    # Create deployment directory
    - /bin/mkdir -p $DEPLOYPATH
    
    # Deploy PHP website (myxen foundation)
    - echo "Deploying PHP website to public_html..."
    - /bin/cp -R "myxen foundation"/.htaccess $DEPLOYPATH/ 2>/dev/null || echo ".htaccess deployed"
    - /bin/cp -R "myxen foundation"/*.php $DEPLOYPATH/ 2>/dev/null || echo "PHP files deployed"
    - /bin/cp -R "myxen foundation"/*.html $DEPLOYPATH/ 2>/dev/null || echo "HTML files deployed"
    - /bin/cp -R "myxen foundation"/*.css $DEPLOYPATH/ 2>/dev/null || echo "CSS files deployed"
    - /bin/cp -R "myxen foundation"/*.js $DEPLOYPATH/ 2>/dev/null || echo "JS files deployed"
    - /bin/cp -R "myxen foundation"/*.json $DEPLOYPATH/ 2>/dev/null || echo "JSON files deployed"
    - /bin/cp -R "myxen foundation"/*.txt $DEPLOYPATH/ 2>/dev/null || echo "TXT files deployed"
    - /bin/cp -R "myxen foundation"/*.xml $DEPLOYPATH/ 2>/dev/null || echo "XML files deployed"
    - /bin/cp -R "myxen foundation"/admin $DEPLOYPATH/ 2>/dev/null || echo "Admin directory deployed"
    - /bin/cp -R "myxen foundation"/api $DEPLOYPATH/ 2>/dev/null || echo "API directory deployed"
    - /bin/cp -R "myxen foundation"/assets $DEPLOYPATH/ 2>/dev/null || echo "Assets directory deployed"
    - /bin/cp -R "myxen foundation"/core $DEPLOYPATH/ 2>/dev/null || echo "Core directory deployed"
    - /bin/cp -R "myxen foundation"/data $DEPLOYPATH/ 2>/dev/null || echo "Data directory deployed"
    - /bin/cp -R "myxen foundation"/includes $DEPLOYPATH/ 2>/dev/null || echo "Includes directory deployed"
    - /bin/cp -R "myxen foundation"/modules $DEPLOYPATH/ 2>/dev/null || echo "Modules directory deployed"
    - /bin/cp -R "myxen foundation"/vendor $DEPLOYPATH/ 2>/dev/null || echo "Vendor directory deployed"
    - /bin/cp -R "myxen foundation"/.well-known $DEPLOYPATH/ 2>/dev/null || echo ".well-known directory deployed"
    - if [ -f "myxen foundation/.env" ]; then /bin/cp "myxen foundation/.env" $DEPLOYPATH/.env && echo "Environment file deployed"; fi
    
    # Deploy Next.js dApp to subdirectory (e.g., /dapp)
    - echo "Deploying Next.js dApp..."
    - /bin/mkdir -p $DEPLOYPATH/dapp
    - if command -v npm >/dev/null 2>&1 && [ -f "package.json" ]; then \
        echo "Node detected. Building root Next.js app..." && \
        npm ci && \
        npm run build && \
        /bin/cp -R out/* $DEPLOYPATH/dapp/ ; \
      else \
        echo "npm not found on server or package.json missing. Skipping DApp build. Use GitHub Actions FTP workflow to deploy /dapp." ; \
      fi
    
    # Install PHP Composer dependencies
    - echo "Installing PHP dependencies..."
    - cd $DEPLOYPATH
    - /usr/local/bin/composer install --no-dev --optimize-autoloader 2>/dev/null || echo "Composer not available or already installed"
    
    # Set correct permissions
    - chmod -R 755 $DEPLOYPATH
    - find $DEPLOYPATH -type f -exec chmod 644 {} \;
    - find $DEPLOYPATH -type d -exec chmod 755 {} \;
    
    # Make sure writable directories have proper permissions
    - chmod -R 777 $DEPLOYPATH/data
    - chmod -R 777 $DEPLOYPATH/assets/qrcodes
    
    # Deploy Backend files (if backend directory exists)
    - echo "Deploying Backend files..."
    - /bin/mkdir -p $BACKENDPATH
    - if [ -d "backend" ]; then \
        /bin/cp -R backend/* $BACKENDPATH/ ; \
        chmod -R 755 $BACKENDPATH ; \
        find $BACKENDPATH -type f -exec chmod 644 {} \; ; \
        find $BACKENDPATH -type d -exec chmod 755 {} \; ; \
        echo "Backend deployed to $BACKENDPATH" ; \
      else \
        echo "No backend directory found, skipping backend deployment" ; \
      fi
    
    # Deploy Subdomains
    - echo "Deploying Subdomains..."
    - export SUBDOMAINSPATH=/home/studyproglobal.com.bd
    
    # Copy all subdomain directories
    - /bin/cp -R subdomains/admin $SUBDOMAINSPATH/admin 2>/dev/null || echo "Admin subdomain copied"
    - /bin/cp -R subdomains/work $SUBDOMAINSPATH/work 2>/dev/null || echo "Work subdomain copied"
    - /bin/cp -R subdomains/career $SUBDOMAINSPATH/career 2>/dev/null || echo "Career subdomain copied"
    - /bin/cp -R subdomains/claim $SUBDOMAINSPATH/claim 2>/dev/null || echo "Claim subdomain copied"
    - /bin/cp -R subdomains/blog $SUBDOMAINSPATH/blog 2>/dev/null || echo "Blog subdomain copied"
    - /bin/cp -R subdomains/wallet $SUBDOMAINSPATH/wallet 2>/dev/null || echo "Wallet subdomain copied"
    - /bin/cp -R subdomains/payments $SUBDOMAINSPATH/payments 2>/dev/null || echo "Payments subdomain copied"
    - /bin/cp -R subdomains/store $SUBDOMAINSPATH/store 2>/dev/null || echo "Store subdomain copied"
    - /bin/cp -R subdomains/meme $SUBDOMAINSPATH/meme 2>/dev/null || echo "Meme subdomain copied"
    - /bin/cp -R subdomains/locker $SUBDOMAINSPATH/locker 2>/dev/null || echo "Locker subdomain copied"
    - /bin/cp -R subdomains/university $SUBDOMAINSPATH/university 2>/dev/null || echo "University subdomain copied"
    - /bin/cp -R subdomains/remit $SUBDOMAINSPATH/remit 2>/dev/null || echo "Remit subdomain copied"
    - /bin/cp -R subdomains/payroll $SUBDOMAINSPATH/payroll 2>/dev/null || echo "Payroll subdomain copied"
    - /bin/cp -R subdomains/student $SUBDOMAINSPATH/student 2>/dev/null || echo "Student subdomain copied"
    - /bin/cp -R subdomains/merchant $SUBDOMAINSPATH/merchant 2>/dev/null || echo "Merchant subdomain copied"
    - /bin/cp -R subdomains/life $SUBDOMAINSPATH/life 2>/dev/null || echo "Life subdomain copied"
    - /bin/cp -R subdomains/agent $SUBDOMAINSPATH/agent 2>/dev/null || echo "Agent subdomain copied"
    - /bin/cp -R subdomains/api-gateway $SUBDOMAINSPATH/api-gateway 2>/dev/null || echo "API Gateway subdomain copied"
    - /bin/cp -R subdomains/docker $SUBDOMAINSPATH/docker 2>/dev/null || echo "Docker subdomain copied"
    
    # Set permissions for all subdomains
    - chmod -R 755 $SUBDOMAINSPATH/admin $SUBDOMAINSPATH/work $SUBDOMAINSPATH/career $SUBDOMAINSPATH/claim $SUBDOMAINSPATH/blog $SUBDOMAINSPATH/wallet $SUBDOMAINSPATH/payments $SUBDOMAINSPATH/store $SUBDOMAINSPATH/meme $SUBDOMAINSPATH/locker $SUBDOMAINSPATH/university $SUBDOMAINSPATH/remit $SUBDOMAINSPATH/payroll $SUBDOMAINSPATH/student $SUBDOMAINSPATH/merchant $SUBDOMAINSPATH/life $SUBDOMAINSPATH/agent $SUBDOMAINSPATH/api-gateway $SUBDOMAINSPATH/docker 2>/dev/null || echo "Permissions set for subdomains"
    - echo "✅ Subdomains deployed successfully!"
    
    - echo "✅ Deployment completed successfully!"
    - echo "Main Site: /home/studyproglobal.com.bd/ (public_html)"
    - echo "Backend API: /home/studyproglobal.com.bd/studypro-backend/"
    - echo "Next.js DApp: /home/studyproglobal.com.bd/dapp/"
    - echo "Subdomains: admin, work, career, claim, blog, wallet, payments, store, meme, locker, university, remit, payroll, student, merchant, life, agent, api-gateway, docker"
